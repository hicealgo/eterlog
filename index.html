<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Cache-Control" content="no-store">
  <meta charset="UTF-8" />
  <title>Eternal Journal v2</title>
  <style id="theme">
    :root {
      --bg: #1e1e1e; --fg: #d4d4d4; --accent: #333;
      --highlight: #555; --label: #888; --shadow: #8882;
      --textarea: #121212;
    }
    body.light {
      --bg: #f5f5f5; --fg: #222; --accent: #ccc;
      --highlight: #aaa; --label: #555; --shadow: #4443;
      --textarea: #fff;
    }
    html, body {
      margin: 0; padding: 0; background: var(--bg);
      color: var(--fg); font: 14px 'Fira Code', monospace;
      height: 100%; overflow: hidden;
    }
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--bg); padding: 8px 16px;
      display: flex; justify-content: space-between;
      align-items: center; border-bottom: 1px solid var(--accent);
      z-index: 1000;
    }
    .top-bar button {
      background: none; border: 1px solid var(--accent);
      color: var(--label); padding: 4px 8px;
      font-size: 12px; cursor: pointer;
    }
    .top-bar button:hover {
      color: var(--fg); border-color: var(--highlight);
    }
    .journal-wrapper {
      position: absolute; top: 40px; bottom: 0;
      left: 0; right: 0; overflow-y: auto; padding: 16px;
    }
    .day-container {
      border-top: 1px solid var(--accent);
      padding-top: 16px; margin-top: 32px;
      scroll-margin-top: 60px;
    }
    .today {
      border: 1px solid var(--highlight);
      box-shadow: 0 0 8px var(--shadow);
      background: var(--bg); position: relative;
    }
    .today::before {
      content: 'üìç Today'; position: absolute;
      top: -20px; right: 20px; font-size: 10px;
      color: var(--label); background: var(--bg);
      padding: 2px 4px;
    }
    h1 { font-size: 18px; margin: 0; text-align: center; }
    h2 { font-size: 14px; text-align: center; margin-top: 4px; color: var(--label); }
    .grid { display: flex; gap: 16px; margin-top: 16px; }
    .entry { flex: 1; display: flex; flex-direction: column; }
    .entry label { font-size: 10px; color: var(--label); margin-bottom: 4px; }
    .entry textarea {
      background: var(--textarea); color: var(--fg);
      border: 1px solid var(--accent); padding: 8px;
      resize: vertical; font: inherit; min-height: 120px;
    }
    .nav-buttons { display: flex; gap: 8px; }
    input[type="date"] {
  background: var(--bg);
  color: var(--fg);
  border: 1px solid var(--accent);
  font: inherit;
  padding: 4px 8px;
  font-size: 12px;
}

  </style>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCgfQGnmF5ETN22ntKpDxSCuJ-KRvuq0q8",
    authDomain: "eterlog-54b08.firebaseapp.com",
    projectId: "eterlog-54b08",
    storageBucket: "eterlog-54b08.firebasestorage.app",
    messagingSenderId: "192406693378",
    appId: "1:192406693378:web:639f9a4188047de521a91b",
    measurementId: "G-RPV4SX0GJR"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>


</head>
<body>
<div class="top-bar">
  <div class="nav-buttons">
    <button onclick="changeDay(-1)">‚Üê Prev</button>
    <button onclick="goToday()">üìç Today</button>
    <button onclick="changeDay(1)">Next ‚Üí</button>
  </div>
<div class="nav-buttons">
<button id="toggleModeBtn" onclick="toggleMode()">üîÅ Toggle Mode</button>
  <button onclick="toggleTheme()">üåì Theme</button>
  <button onclick="downloadAll()">‚¨á Download All</button>
  <button id="login-btn" onclick="signInWithGoogle()">üîê Sign In</button>
  <button id="logout-btn" onclick="signOut()" style="display:none">üîì Sign Out</button>
  <input type="date" id="date-picker" onchange="goToDate(this.value)" style="margin-left: 8px;">
</div>
  <div id="user-info" style="font-size:12px; color:var(--label); margin-left:16px;"></div>
</div>


  <div id="journal" class="journal-wrapper"></div>
  <script>
    let mode = 'single';
    if ('scrollRestoration' in history) {
  history.scrollRestoration = 'manual';
}

    let baseDate = new Date();
    const journal = document.getElementById('journal');
    const todayStr = formatDate(new Date());
    const MAX_VISIBLE_DAYS = 15;
    const rendered = new Map();

    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');


function hardResetToSingleMode() {
  mode = 'single';
  baseDate = new Date();

  // üö´ remove scroll listener
  journal.onscroll = null;

  // üí£ wipe scroll data and content
  journal.innerHTML = '';
  journal.scrollTop = 0;
  rendered.clear();

  // üßº render just today
  renderSingle(formatDate(baseDate));
}

    function toggleTheme() {
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light')? 'light' : 'dark');
    }
    function updateToggleLabel() {
  const btn = document.getElementById('toggleModeBtn');
  if (mode === 'single') {
    btn.textContent = 'üîÅ Toggle to Continuous View';
  } else {
    btn.textContent = 'üîÅ Toggle to Single Day View';
  }
}

    function formatDate(d) {
      const iso = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
      return iso.toISOString().split('T')[0];
    }
    function getDayName(d) {
      return d.toLocaleDateString(undefined, {weekday:'long',timeZone:'UTC'});
    }
function loadEntry(date) {
  if (auth.currentUser) {
    return db.collection("journals").doc(auth.currentUser.uid)
      .collection("entries").doc(date)
      .get().then(doc => doc.exists ? doc.data() : {});
  } else {
    return Promise.resolve(JSON.parse(localStorage.getItem('journal_' + date) || '{}'));
  }
}

function saveEntry(date, e) {
  if (auth.currentUser) {
    if (typeof e.then === "function") {
      console.error("‚ùå Trying to save a Promise instead of an object:", e);
      return;
    }
    db.collection("journals").doc(auth.currentUser.uid)
      .collection("entries").doc(date).set(e);
  } else {
    localStorage.setItem('journal_' + date, JSON.stringify(e));
  }
}

async function createDay(date) {
  const entry = await loadEntry(date);
  const div = document.createElement('div');
  div.className = 'day-container';
  if (date === todayStr) div.classList.add('today');
  div.dataset.date = date;
  const dn = getDayName(new Date(date));
  div.innerHTML = `
    <h1>${date}</h1><h2>${dn}</h2>
    <div class="grid">
      ${['todo','done','misc'].map(f=>`
        <div class="entry">
          <label>${f.toUpperCase()}</label>
          <textarea data-date="${date}" data-field="${f}">${entry[f]||''}</textarea>
        </div>`).join('')}
    </div>`;
  return div;
}

    function attachListeners(el=document) {
      el.querySelectorAll('textarea').forEach(t=>{
t.oninput = async () => {
  const d = t.dataset.date;
  const f = t.dataset.field;
  const e = await loadEntry(d); // üëà esperar a que cargue el objeto real
  e[f] = t.value;
  saveEntry(d, e); // üëà ahora s√≠: e es un objeto
};
      });
    }

async function renderSingle(date = formatDate(baseDate)) {
  // Si ya existe, solo ocultamos el resto
  for (const [d, el] of rendered.entries()) {
    el.style.display = (d === date) ? '' : 'none';
  }

  // Si no existe, creamos el d√≠a y lo agregamos
  if (!rendered.has(date)) {
    const el = await createDay(date);
    if (el) {
      journal.appendChild(el);
      rendered.set(date, el);
    }
  }

  attachListeners();
  journal.scrollTop = 0;
  document.getElementById('date-picker').value = formatDate(baseDate);

}


function goToday() {
  baseDate = new Date();
  if (mode === 'single') {
    renderSingle(formatDate(baseDate));
  } else {
    rendered.clear();
    renderScroll();
  }
}

function changeDay(offset) {
  if (mode === 'single') {
    baseDate = new Date(baseDate.getTime());
    baseDate.setDate(baseDate.getDate() + offset);
    renderSingle(formatDate(baseDate));
  } else {
    journal.scrollBy({
      top: offset * journal.clientHeight,
      behavior: 'smooth'
    });
  }
}

function toggleMode() {
  if (mode === 'single') {
    mode = 'scroll';
    renderScroll();
  } else {
    hardResetToSingleMode();
  }
  updateToggleLabel(); // üîÅ update label after switching
}


async function renderScroll() {
  const centerDateStr = formatDate(baseDate);
  const daysToShow = [];

  // Armamos lista de d√≠as -6 a +6 para buen margen
  for (let i = -6; i <= 6; i++) {
    const d = new Date(baseDate);
    d.setDate(d.getDate() + i);
    daysToShow.push(formatDate(d));
  }

  // Ordenar por fecha real
  daysToShow.sort();

  // Crear si no existe y guardar en array temporal
  const elements = [];

  for (const dateStr of daysToShow) {
    let el = rendered.get(dateStr);
    if (!el) {
      el = await createDay(dateStr);
      if (el) rendered.set(dateStr, el);
    }
    if (el) {
      el.style.display = '';
      elements.push([dateStr, el]);
    }
  }

  // Limpiar contenedor y reinsertar en orden
  journal.innerHTML = '';
  for (const [_, el] of elements) {
    journal.appendChild(el);
  }

  attachListeners();
  setupScroll();

  // Scroll a la fecha central ya ordenada
  const targetEl = rendered.get(centerDateStr);
  if (targetEl) {
    journal.scrollTop = targetEl.offsetTop - 100;
  }
}







function scrollToDate(targetDateStr) {
  const el = document.querySelector(`.day-container[data-date="${targetDateStr}"]`);
  if (el) {
    journal.scrollTo({ top: el.offsetTop - 100, behavior: 'instant' });
  } else {
    setTimeout(() => scrollToDate(targetDateStr), 50);
  }
}

function setupScroll() {
  let isLoading = false;

  journal.onscroll = async () => {
    if (isLoading) return;
    isLoading = true;

    const st = journal.scrollTop, sh = journal.scrollHeight,
          ch = journal.clientHeight, buf = 200;

    const fd = new Date(journal.firstChild?.dataset.date),
          ld = new Date(journal.lastChild?.dataset.date);

    // ‚¨ÜÔ∏è Scroll hacia el pasado
    if (st < buf) {
      const prevHeight = journal.scrollHeight;

      for (let i = 1; i <= 3; i++) {
        const d = new Date(fd);
        d.setDate(fd.getDate() - i);
        const s = formatDate(d);
        if (!rendered.has(s)) {
          const el = await createDay(s);
          if (el) {
            journal.prepend(el);
            rendered.set(s, el);
          }
        }
      }

      const heightDiff = journal.scrollHeight - prevHeight;
      journal.scrollTop += heightDiff; // üß† evita el salto
    }

    // ‚¨áÔ∏è Scroll hacia el futuro
    if (st + ch > sh - buf) {
      for (let i = 1; i <= 3; i++) {
        const d = new Date(ld);
        d.setDate(ld.getDate() + i);
        const s = formatDate(d);
        if (!rendered.has(s)) {
          const el = await createDay(s);
          if (el) {
            journal.appendChild(el);
            rendered.set(s, el);
          }
        }
      }
    }

    // üßΩ Limpiar d√≠as viejos para mantener memoria controlada
    while (journal.children.length > MAX_VISIBLE_DAYS) {
      const rm = journal.scrollTop > journal.scrollHeight / 2
        ? journal.firstChild
        : journal.lastChild;
      rendered.delete(rm.dataset.date);
      journal.removeChild(rm);
    }

    // üß∑ Reasignar listeners
    attachListeners();

    // üìÖ Detectar primer d√≠a completamente visible
    const journalRect = journal.getBoundingClientRect();
    for (const [dateStr, el] of rendered.entries()) {
      const rect = el.getBoundingClientRect();
      const fullyVisible = rect.top >= journalRect.top && rect.bottom <= journalRect.bottom;
      if (fullyVisible) {
        document.getElementById('date-picker').value = dateStr;
        break;
      }
    }

    isLoading = false;
  };
}




    function downloadAll(){
      const out={};
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k.startsWith('journal_')){
          out[k.slice(8)] = loadEntry(k.slice(8));
        }
      }
      const b=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(b);
      a.download='journal_all.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    renderSingle();


function goToDate(dateStr) {
  if (!dateStr) return;
  const [y, m, d] = dateStr.split('-').map(Number);
  baseDate = new Date(y, m - 1, d); // üëà crea con fecha local sin desfasar

  if (mode === 'single') {
    renderSingle(formatDate(baseDate));
  } else {
    rendered.clear();
    renderScroll();
  }
}

updateToggleLabel();

function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(userCred => {
      const user = userCred.user;
      console.log("‚úÖ Logged in as:", user.email);
      
      // Mostrar el correo en pantalla
      document.getElementById("user-info").textContent = `üë§ ${user.email}`;
      
      // Oculta login, muestra logout
      document.getElementById("login-btn").style.display = "none";
      document.getElementById("logout-btn").style.display = "inline-block";

      // Renderiza desde hoy
      journal.innerHTML = '';
      baseDate = new Date();
      renderSingle(formatDate(baseDate));
    })
    .catch(error => {
      console.error("Login error:", error);
    });
}


function signOut() {
  auth.signOut().then(() => {
    console.log("Signed out.");
    document.getElementById("login-btn").style.display = "inline-block";
    document.getElementById("logout-btn").style.display = "none";
    document.getElementById("user-info").textContent = '';
    journal.innerHTML = '';
    baseDate = new Date();
    renderSingle(formatDate(baseDate));
  }).catch(error => {
    console.error("Sign out error:", error);
  });
}

auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById("login-btn").style.display = "none";
    document.getElementById("logout-btn").style.display = "inline-block";
    document.getElementById("user-info").textContent = `üë§ ${user.email}`;
  } else {
    document.getElementById("login-btn").style.display = "inline-block";
    document.getElementById("logout-btn").style.display = "none";
    document.getElementById("user-info").textContent = '';
  }
});


  </script>
</body>
</html>
